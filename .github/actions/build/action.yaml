name: Build Cobalt
description: Builds Cobalt targets
inputs:
  build_target_platform: 
    required: true
  build_config: 
    required: true
  build_target: 
    required: true
runs:
  using: "composite"
  steps:
    - name: Set Android env vars
      if: startsWith(${{matrix.target_platform}}, 'android')
      run: |
        echo "ANDROID_HOME=/root/starboard-toolchains/AndroidSdk/" >> $GITHUB_ENV
        echo "COBALT_GRADLE_BUILD_COUNT=4" >> $GITHUB_ENV
        echo "GCS_NIGHTLY_PATH=gs://cobalt-actions-devel-build-artifacts" >> $GITHUB_ENV
        echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
      shell: bash
    - name: Print env vars
      run: env | sort
      shell: bash
    - name: Build ${{matrix.platform}}-${{matrix.config}}
      env:
        TARGET: ${{ inputs.build_target_platform }}
      run: |
           set -x
           # GitHub Runners have home set to /github/home.
           if [ -d /root/starboard-toolchains ]; then
             ln -s /root/starboard-toolchains /github/home/starboard-toolchains
           fi
           target=all
           if [[ "${{ matrix.config }}" =~ ^(qa|gold)$ ]]; then
             target=default
           fi
           ninja -v -C ${GITHUB_WORKSPACE}/out/${TARGET}_${{ github.events.inputs.build_config }} ${{ inputs.build_target }}
      shell: bash
    - name: Show Sccache Stats
      run: sccache -s
      shell: bash
